

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>mldap &mdash; mldap beta documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="mldap beta documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">mldap beta documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for mldap</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c">################################################################################</span>
<span class="c"># Shaun Meyer - June, 2009</span>
<span class="c"># Custom AD/LDAP Worker Library for Morningside College 2003 AD Domain</span>
<span class="c"># SRGM Oct, 2011</span>
<span class="c">#   * Continuing code cleanup for GITHUB publication.</span>
<span class="c"># SRGM Aug, 2011</span>
<span class="c">#   * FEATURE: Major cleanup + documenting. </span>
<span class="c">#   * FEATURE: Added uac object</span>
<span class="c"># SRGM Jul, 2011</span>
<span class="c">#   * FEATURE: Converted from execfile() to ConfigParser() for credsfile</span>
<span class="c"># SRGM Oct, 2010</span>
<span class="c">#   * REWRITE: Adding ADUser and ADGroup objects</span>
<span class="c"># SRGM Jul, 2009</span>
<span class="c">#   * REWRITE: Now Object-Oriented for trialling purposes</span>
<span class="c"># SRGM Jun, 2009 </span>
<span class="c">#   * FEATURE: create() for new accounts</span>
<span class="c">################################################################################</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">ldap</span>
<span class="kn">from</span> <span class="nn">ldap.controls</span> <span class="kn">import</span> <span class="n">SimplePagedResultsControl</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">base64</span> <span class="c"># for password obfuscation</span>

<span class="kn">import</span> <span class="nn">pprint</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;1.0.3&quot;</span>

<span class="c"># Enable all warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="deprecated"><a class="viewcode-back" href="../mldap.html#mldap.deprecated">[docs]</a><span class="k">def</span> <span class="nf">deprecated</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Call this function with an optional message to raise a warning</span>
<span class="sd">    for a depracated function. &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;This function is deprecated.&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>


<span class="c">#</span>
<span class="c">## Read up the configuration stuff (or die trying)</span>
<span class="c">#</span>
</div>
<span class="n">CREDSFILE</span> <span class="o">=</span> <span class="s">&#39;/etc/ldap.creds&#39;</span>

<div class="viewcode-block" id="read_creds"><a class="viewcode-back" href="../mldap.html#mldap.read_creds">[docs]</a><span class="k">def</span> <span class="nf">read_creds</span><span class="p">(</span><span class="n">credsfile</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read in the config file and return its data as a dictionary.</span>
<span class="sd">    </span>
<span class="sd">    Example:</span>
<span class="sd">    [LDAP]</span>
<span class="sd">    SERVER=ldap://my.server.url</span>
<span class="sd">    USERNAME=administrator@my.domain.url</span>
<span class="sd">    PASSWORD=some_base64_encoded_str=</span>
<span class="sd">    BASE=dc=my,dc=domain,dc=url</span>
<span class="sd">    DOMAIN=my.domain.url</span>
<span class="sd">    USER_BASE=ou=Users,dc=my,dc=domain,dc=url</span>
<span class="sd">    GROUP_BASE=ou=Groups,dc=my,dc=domain,dc=url</span>
<span class="sd">    ...</span>

<span class="sd">    @return: Dictionary with keys(): (&#39;LDAP_USERNAME&#39;, &#39;LDAP_PASSWORD&#39;,</span>
<span class="sd">    &#39;LDAP_SERVER&#39;, &#39;LDAP_BASE&#39;, &#39;LDAP_DOMAIN&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">credsfile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">credsfile</span> <span class="o">=</span> <span class="n">CREDSFILE</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">credsfile</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s">&#39;LDAP&#39;</span><span class="p">)</span>

    <span class="n">creds</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;LDAP_USERNAME&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LDAP&#39;</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">),</span>
        <span class="s">&#39;LDAP_PASSWORD&#39;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LDAP&#39;</span><span class="p">,</span> <span class="s">&#39;password&#39;</span><span class="p">)),</span>
        <span class="s">&#39;LDAP_SERVER&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LDAP&#39;</span><span class="p">,</span> <span class="s">&#39;server&#39;</span><span class="p">),</span>
        <span class="s">&#39;LDAP_BASE&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LDAP&#39;</span><span class="p">,</span> <span class="s">&#39;base&#39;</span><span class="p">),</span>
        <span class="s">&#39;LDAP_DOMAIN&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LDAP&#39;</span><span class="p">,</span> <span class="s">&#39;domain&#39;</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="c"># Handle optional fields.</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&#39;LDAP&#39;</span><span class="p">,</span> <span class="s">&#39;group_base&#39;</span><span class="p">):</span>
        <span class="n">creds</span><span class="p">[</span><span class="s">&#39;LDAP_GROUP_BASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LDAP&#39;</span><span class="p">,</span> <span class="s">&#39;group_base&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">creds</span><span class="p">[</span><span class="s">&#39;LDAP_GROUP_BASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">creds</span><span class="p">[</span><span class="s">&#39;LDAP_BASE&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&#39;LDAP&#39;</span><span class="p">,</span> <span class="s">&#39;user_base&#39;</span><span class="p">):</span>
        <span class="n">creds</span><span class="p">[</span><span class="s">&#39;LDAP_USER_BASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LDAP&#39;</span><span class="p">,</span> <span class="s">&#39;user_base&#39;</span><span class="p">),</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">creds</span><span class="p">[</span><span class="s">&#39;LDAP_USER_BASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">creds</span><span class="p">[</span><span class="s">&#39;LDAP_BASE&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">creds</span>
        
<span class="c">#creds = read_creds()</span>
</div>
<div class="viewcode-block" id="flatten"><a class="viewcode-back" href="../mldap.html#mldap.flatten">[docs]</a><span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; given a list of no elements, return None.</span>
<span class="sd">    given a list of one element, return just the element,</span>
<span class="sd">    given a list of more than one element, return the list. &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">l</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">l</span>

<span class="c">################################################################################</span>
<span class="c"># ADuser &amp; ADGroup Classes</span>
<span class="c">################################################################################</span>
</div>
<span class="k">class</span> <span class="nc">ADuser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">attr_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;firstname&#39;</span><span class="p">:</span> <span class="s">&#39;givenName&#39;</span><span class="p">,</span>
        <span class="s">&#39;initial&#39;</span><span class="p">:</span> <span class="s">&#39;initials&#39;</span><span class="p">,</span>
        <span class="s">&#39;lastname&#39;</span><span class="p">:</span><span class="s">&#39;sn&#39;</span><span class="p">,</span>
        <span class="s">&#39;idno&#39;</span><span class="p">:</span> <span class="s">&#39;employeeNumber&#39;</span><span class="p">,</span>
        <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="s">&#39;mail&#39;</span><span class="p">,</span>
        <span class="s">&#39;distinguishedName&#39;</span><span class="p">:</span> <span class="s">&#39;distinguishedName&#39;</span>
        <span class="p">}</span>

    <span class="sd">&#39;&#39;&#39; attributes that are allowed to be written back to AD &#39;&#39;&#39;</span>
    <span class="n">writable_attributes</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;mail&#39;</span><span class="p">,</span>
                            <span class="s">&#39;givenName&#39;</span><span class="p">,</span>
                            <span class="s">&#39;initials&#39;</span><span class="p">,</span>
                            <span class="s">&#39;sn&#39;</span><span class="p">,</span>
                            <span class="s">&#39;employeeNumber&#39;</span><span class="p">,</span>
                            <span class="s">&#39;userPrincipalName&#39;</span>
        <span class="p">]</span>

    <span class="c"># def deduce_usertype_from_dn(self):</span>
    <span class="c">#     &quot;&quot;&quot; Attempt to deduce the usertype field from the dn.</span>
    <span class="c">#     @return: the usertype OR the head of the DN (sans const.BASE)</span>
    <span class="c">#     if no type matches. &quot;&quot;&quot;</span>

    <span class="c">#     o = self.dn</span>
    <span class="c">#     o = o.replace(&#39;,&#39;+const.BASE, &#39;&#39;) # remove BASE portion</span>
    <span class="c">#     o = &quot;,&quot;.join(o.split(&#39;,&#39;)[1:]) # remove CN= head portion</span>
        
    <span class="c">#     if o in const.rev_usertype_map:</span>
    <span class="c">#         return const.rev_usertype_map[o]</span>
        

    <span class="c">#     &#39;&#39;&#39; usertype is not recognized, </span>
    <span class="c">#     return partial OU head for debug. &#39;&#39;&#39;</span>
    <span class="c">#     return self.dn.replace(&#39;,&#39;+const.BASE, &#39;&#39;)</span>

    <span class="k">def</span> <span class="nf">_get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ad_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;givenName&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;initials&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;sn&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;employeeNumber&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;mail&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> 
                            <span class="s">&#39;memberOf&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;distinguishedName&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">}</span>

        <span class="n">ad_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ad</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">ad_attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                       
        <span class="bp">self</span><span class="o">.</span><span class="n">firstname</span> <span class="o">=</span> <span class="n">ad_attributes</span><span class="p">[</span><span class="s">&#39;givenName&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial</span>   <span class="o">=</span> <span class="n">ad_attributes</span><span class="p">[</span><span class="s">&#39;initials&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastname</span>  <span class="o">=</span> <span class="n">ad_attributes</span><span class="p">[</span><span class="s">&#39;sn&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idno</span>      <span class="o">=</span> <span class="n">ad_attributes</span><span class="p">[</span><span class="s">&#39;employeeNumber&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span>     <span class="o">=</span> <span class="n">ad_attributes</span><span class="p">[</span><span class="s">&#39;mail&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span>        <span class="o">=</span> <span class="n">ad_attributes</span><span class="p">[</span><span class="s">&#39;distinguishedName&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expired</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adcon</span><span class="o">.</span><span class="n">isexpired</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usertype</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deduce_usertype_from_dn</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">guid</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adcon</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;objectGUID&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ad</span><span class="o">.</span><span class="n">isdisabled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">networkstatus</span> <span class="o">=</span> <span class="s">&quot;DISABLED&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">networkstatus</span> <span class="o">=</span> <span class="s">&quot;ENABLED&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">ad_obj</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">attributes</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">ad_obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adcon</span> <span class="o">=</span> <span class="n">mldap</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adcon</span> <span class="o">=</span> <span class="n">ad_obj</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adcon</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initiated</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span>

        <span class="c">#self._get_info()</span>

        <span class="k">if</span> <span class="n">attributes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adcon</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initiated</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; commit back attribute changes to active directory &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initiated</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">adcon</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="sd">&#39;&#39;&#39; This will handle all easy attributes &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">writable_attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adcon</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">ad_attr</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: mismatch: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sAMAccountName</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="c">#adcon.replace(self.username, ad_attr, self.__getattribute__(attr))</span>

        <span class="sd">&#39;&#39;&#39; Handle username changes? &#39;&#39;&#39;</span>
        

    <span class="k">def</span> <span class="nf">update_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; update user attributes from another user type. &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;cn&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&lt;ADUser: &#39;</span><span class="si">%(cn)s</span><span class="s">&#39; (</span><span class="si">%(sAMAccountName)s</span><span class="s">)&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&lt;AD User Object(uninitialized)&gt;&quot;</span>
        
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectGUID</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">objectGUID</span>


<span class="k">class</span> <span class="nc">ADgroup</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="n">ad_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;dn&#39;</span><span class="p">:</span><span class="n">dn</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span><span class="n">groupname</span><span class="p">,</span> <span class="s">&#39;members&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ad</span> <span class="o">=</span> <span class="n">ad_obj</span>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">members</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;ADGroup: &#39;</span><span class="si">%s</span><span class="s">&#39; having </span><span class="si">%d</span><span class="s"> users&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">members</span><span class="p">))</span>
    
<span class="c">################################################################################</span>
<span class="c"># Some UAC (user Account Control) codes</span>
<span class="c">################################################################################</span>
<div class="viewcode-block" id="uac"><a class="viewcode-back" href="../mldap.html#mldap.uac">[docs]</a><span class="k">class</span> <span class="nc">uac</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A quick definition of some constants in the </span>
<span class="sd">    userAccountControl attribute. &quot;&quot;&quot;</span>
 
    <span class="sd">&quot;&quot;&quot; Default value (0) &quot;&quot;&quot;</span>
    <span class="n">uac_value</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="sd">&quot;&quot;&quot; The logon script is executed. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_SCRIPT</span> <span class="o">=</span> <span class="mh">0x00000001</span>

    <span class="sd">&quot;&quot;&quot; The user account is disabled. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_ACCOUNTDISABLE</span> <span class="o">=</span> <span class="mh">0x00000002</span>

    <span class="sd">&quot;&quot;&quot; The home directory is required. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_HOMEDIR_REQUIRED</span> <span class="o">=</span> <span class="mh">0x00000008</span>

    <span class="sd">&quot;&quot;&quot; The account is currently locked out. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_LOCKOUT</span> <span class="o">=</span> <span class="mh">0x00000010</span>

    <span class="sd">&quot;&quot;&quot;  No password is required.  &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_PASSWD_NOTREQD</span> <span class="o">=</span> <span class="mh">0x00000020</span>

    <span class="sd">&quot;&quot;&quot; The user cannot change the password.  Note You cannot assign</span>
<span class="sd">    the permission settings of PASSWD_CANT_CHANGE by directly modifying</span>
<span class="sd">    the UserAccountControl attribute. For more information and a code</span>
<span class="sd">    example that shows how to prevent a user from changing the password,</span>
<span class="sd">    see User Cannot Change Password. </span>
<span class="sd">    (http://msdn.microsoft.com/en-us/library/aa746508(v=vs.85).aspx ) &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_PASSWD_CANT_CHANGE</span> <span class="o">=</span> <span class="mh">0x00000040</span>

    <span class="sd">&quot;&quot;&quot; The user can send an encrypted password. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_ENCRYPTED_TEXT_PASSWORD_ALLOWED</span> <span class="o">=</span> <span class="mh">0x00000080</span>

    <span class="sd">&quot;&quot;&quot; This is an account for users whose primary account is in</span>
<span class="sd">    another domain. This account provides user access to this domain,</span>
<span class="sd">    but not to any domain that trusts this domain. Also known as a</span>
<span class="sd">    local user account. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_TEMP_DUPLICATE_ACCOUNT</span> <span class="o">=</span> <span class="mh">0x00000100</span>

    <span class="sd">&quot;&quot;&quot; This is a default account type that represents a typical user. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_NORMAL_ACCOUNT</span> <span class="o">=</span> <span class="mh">0x00000200</span>

    <span class="sd">&quot;&quot;&quot; This is a permit to trust account for a system domain that trusts </span>
<span class="sd">    other domains. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_INTERDOMAIN_TRUST_ACCOUNT</span> <span class="o">=</span> <span class="mh">0x00000800</span>

    <span class="sd">&quot;&quot;&quot; This is a computer account for a computer that is a member of this </span>
<span class="sd">    domain. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_WORKSTATION_TRUST_ACCOUNT</span> <span class="o">=</span> <span class="mh">0x00001000</span>

    <span class="sd">&quot;&quot;&quot; This is a computer account for a system backup domain controller that </span>
<span class="sd">    is a member of this domain. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_SERVER_TRUST_ACCOUNT</span> <span class="o">=</span> <span class="mh">0x00002000</span>

    <span class="sd">&quot;&quot;&quot; The password for this account will never expire. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_DONT_EXPIRE_PASSWD</span> <span class="o">=</span> <span class="mh">0x00010000</span>

    <span class="sd">&quot;&quot;&quot; This is an MNS logon account. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_MNS_LOGON_ACCOUNT</span> <span class="o">=</span> <span class="mh">0x00020000</span>

    <span class="sd">&quot;&quot;&quot; The user must log on using a smart card. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_SMARTCARD_REQUIRED</span> <span class="o">=</span> <span class="mh">0x00040000</span>

    <span class="sd">&quot;&quot;&quot; The service account (user or computer account), under which a</span>
<span class="sd">    service runs, is trusted for Kerberos delegation. Any such service</span>
<span class="sd">    can impersonate a client requesting the service. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_TRUSTED_FOR_DELEGATION</span> <span class="o">=</span> <span class="mh">0x00080000</span>

    <span class="sd">&quot;&quot;&quot; The security context of the user will not be delegated to a</span>
<span class="sd">    service even if the service account is set as trusted for Kerberos</span>
<span class="sd">    delegation. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_NOT_DELEGATED</span> <span class="o">=</span> <span class="mh">0x00100000</span>

    <span class="sd">&quot;&quot;&quot; Restrict this principal to use only Data Encryption Standard</span>
<span class="sd">    (DES) encryption types for keys. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_USE_DES_KEY_ONLY</span> <span class="o">=</span> <span class="mh">0x00200000</span>

    <span class="sd">&quot;&quot;&quot; This account does not require Kerberos pre-authentication for</span>
<span class="sd">    logon. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_DONT_REQUIRE_PREAUTH</span> <span class="o">=</span> <span class="mh">0x00400000</span>

    <span class="sd">&quot;&quot;&quot; The user password has expired. This flag is created by the</span>
<span class="sd">    system using data from the Pwd-Last-Set attribute and the domain</span>
<span class="sd">    policy. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_PASSWORD_EXPIRED</span> <span class="o">=</span> <span class="mh">0x00800000</span>

    <span class="sd">&quot;&quot;&quot; The account is enabled for delegation. This is a</span>
<span class="sd">    security-sensitive setting; accounts with this option enabled</span>
<span class="sd">    should be strictly controlled. This setting enables a service</span>
<span class="sd">    running under the account to assume a client identity and</span>
<span class="sd">    authenticate as that user to other remote servers on the</span>
<span class="sd">    network. &quot;&quot;&quot;</span>
    <span class="n">ADS_UF_TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</span> <span class="o">=</span> <span class="mh">0x01000000</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="uac.flags"><a class="viewcode-back" href="../mldap.html#mldap.uac.flags">[docs]</a>    <span class="k">def</span> <span class="nf">flags</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; iterate through flags (using dir()) and return a human-legible</span>
<span class="sd">        rendition of account flags. &quot;&quot;&quot;</span>

        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">uac</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;ADS&#39;</span> <span class="ow">in</span> <span class="n">flag</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="n">cls</span><span class="p">()</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">flag</span><span class="p">):</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>    
</div>
<div class="viewcode-block" id="uac.instance_flags"><a class="viewcode-back" href="../mldap.html#mldap.uac.instance_flags">[docs]</a>    <span class="k">def</span> <span class="nf">instance_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; @return: a list of user-readable flags which are set. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">uac</span><span class="o">.</span><span class="n">flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uac_value</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uac_value</span> <span class="o">|=</span> <span class="nb">int</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">unset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uac_value</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="nb">int</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">is_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uac_value</span> <span class="o">&amp;</span> <span class="nb">int</span><span class="p">(</span><span class="n">flag</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__int__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uac_value</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uac_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s"> object (</span><span class="si">%s</span><span class="s">)&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">setuac</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samaccountname</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;No AD data member to commit&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ad</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samaccountname</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uac_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance_flags</span>


<span class="c">###############################################################################</span>
<span class="c">###############################################################################</span>
<span class="c">#</span>
<span class="c"># BEGIN MLDAP OBJECT DEFINITION</span>
<span class="c">#</span>
<span class="c">###############################################################################</span>
<span class="c">###############################################################################</span>
</div>
<div class="viewcode-block" id="mldap"><a class="viewcode-back" href="../mldap.html#mldap.mldap">[docs]</a><span class="k">class</span> <span class="nc">mldap</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; This class is specifically designed to connect to and interact with </span>
<span class="sd">    our Active Directory via LDAP. </span>
<span class="sd">    </span>
<span class="sd">    Named parameters: </span>
<span class="sd">      * credsfile</span>
<span class="sd">      * LDAP_USERNAME</span>
<span class="sd">      * LDAP_PASSWORD</span>
<span class="sd">      * LDAP_SERVER</span>
<span class="sd">      * LDAP_BASE</span>
<span class="sd">      * LDAP_USER_BASE</span>
<span class="sd">      * LDAP_GROUP_BASE</span>
<span class="sd">      * LDAP_DOMAIN</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read default creds file. If keyword credentials are specified </span>
<span class="sd">        during object instantiation, those superceded the file. </span>

<span class="sd">        @type creds: Dictionary</span>
<span class="sd">        @param creds: Dictionary which optionally contains LDAP_USERNAME,</span>
<span class="sd">        LDAP_PASSWORD, or LDAP_SERVER keys to override what is loaded from </span>
<span class="sd">        the credsfile variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">credsfile</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;credsfile&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;credsfile&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">CREDSFILE</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">credsfile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">read_creds</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;credsfile&#39;</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<div class="viewcode-block" id="mldap.alive"><a class="viewcode-back" href="../mldap.html#mldap.mldap.alive">[docs]</a>    <span class="k">def</span> <span class="nf">alive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A quick test to verify if a connection is still active. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_USERNAME</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">LDAPError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot; e will be &quot;LDAP connection invalid&quot; though I&#39;m avoiding</span>
<span class="sd">            doing a string compare on this fact. &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># build a client</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span> <span class="o">=</span> <span class="n">ldap</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_SERVER</span><span class="p">)</span>
            <span class="c"># I added this from the internet to fix this new problem</span>
            <span class="c"># where our bind isn&#39;t working?? seemed to fix it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="n">ldap</span><span class="o">.</span><span class="n">OPT_REFERRALS</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

            <span class="c"># perform a synchronous bind</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">simple_bind_s</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LDAP_USERNAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LDAP_PASSWORD</span><span class="p">)</span>
        
        <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">INVALID_CREDENTIALS</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Invalid credentials: &quot;</span><span class="p">,</span><span class="n">e</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">SERVER_DOWN</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Your server (</span><span class="si">%s</span><span class="s">) appears to be down.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">LDAP_SERVER</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;  </span><span class="si">%(info)s</span><span class="se">\n</span><span class="s">  </span><span class="si">%(desc)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span>


    <span class="c"># TODO: Remove this function!                             </span>
<div class="viewcode-block" id="mldap.checkidno"><a class="viewcode-back" href="../mldap.html#mldap.mldap.checkidno">[docs]</a>    <span class="k">def</span> <span class="nf">checkidno</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idno</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Taking an IDNO as only argument, does a search in the</span>
<span class="sd">        employeeNumber LDAP field for this value.</span>

<span class="sd">        @param idno: string containing the users 7-digit ID.NO</span>

<span class="sd">        @return:</span>
<span class="sd">            sAMAccountName or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">searchpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_USER_BASE</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;(&amp;(employeeNumber=</span><span class="si">%s</span><span class="s">))&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">idno</span> <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">searchpath</span><span class="p">,</span>
            <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
            <span class="n">search</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;distinguishedName&#39;</span><span class="p">,</span><span class="s">&#39;sAMAccountName&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;sAMAccountName&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;sAMAccountName&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


<span class="c"># </span>
<span class="c"># Check if an account exists based on the presence of a sAMAccountName</span>
<span class="c">#</span>
</div>
<div class="viewcode-block" id="mldap.exists"><a class="viewcode-back" href="../mldap.html#mldap.mldap.exists">[docs]</a>    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if an account exists based on the presence of a sAMAccountName </span>
<span class="sd">        @return: True/False &quot;&quot;&quot;</span>
        <span class="n">searchpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_BASE</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;samaccountname=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
                <span class="n">searchpath</span><span class="p">,</span>
                <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
                <span class="n">search</span><span class="p">,</span>
                <span class="p">[</span><span class="s">&#39;sAMAccountName&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s">&quot;sAMAccountName&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

<span class="c">#</span>
<span class="c"># Peruse a given base OU and return all sAMAccountNames...</span>
<span class="c">#</span>
</div>
<div class="viewcode-block" id="mldap.listou"><a class="viewcode-back" href="../mldap.html#mldap.mldap.listou">[docs]</a>    <span class="k">def</span> <span class="nf">listou</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
               <span class="n">base</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
               <span class="n">objectType</span><span class="o">=</span><span class="s">&#39;samaccountname&#39;</span><span class="p">,</span>
               <span class="n">pageSize</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; List all sAMAccountNames of a given OU &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LDAP_USER_BASE</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">=*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">objectType</span><span class="p">)</span>

        <span class="n">lc</span> <span class="o">=</span> <span class="n">SimplePagedResultsControl</span><span class="p">(</span>
            <span class="n">ldap</span><span class="o">.</span><span class="n">LDAP_CONTROL_PAGE_OID</span><span class="p">,</span><span class="bp">True</span><span class="p">,(</span><span class="n">pageSize</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">))</span>

        <span class="n">msgid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_ext</span><span class="p">(</span>
            <span class="n">base</span><span class="p">,</span>
            <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
            <span class="n">search</span><span class="p">,</span>
            <span class="n">serverctrls</span><span class="o">=</span><span class="p">[</span><span class="n">lc</span><span class="p">])</span>

        <span class="n">results</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">rtype</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span> <span class="n">rmsgid</span><span class="p">,</span> <span class="n">serverctrls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">result3</span><span class="p">(</span><span class="n">msgid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dn</span><span class="p">,</span><span class="n">entry</span> <span class="ow">in</span> <span class="n">rdata</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">+=</span> <span class="n">entry</span><span class="p">[</span><span class="s">&#39;sAMAccountName&#39;</span><span class="p">]</span>

            <span class="n">pctrls</span> <span class="o">=</span> <span class="p">[</span>
              <span class="n">c</span>
              <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">serverctrls</span>
              <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">controlType</span> <span class="o">==</span> <span class="n">ldap</span><span class="o">.</span><span class="n">LDAP_CONTROL_PAGE_OID</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="n">pctrls</span><span class="p">:</span>
                <span class="n">est</span><span class="p">,</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">pctrls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">controlValue</span>
                <span class="k">if</span> <span class="n">cookie</span><span class="p">:</span>
                    <span class="n">lc</span><span class="o">.</span><span class="n">controlValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">pageSize</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>
                    <span class="n">msgid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_ext</span><span class="p">(</span>
                        <span class="n">base</span><span class="p">,</span> 
                        <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span> 
                        <span class="n">search</span><span class="p">,</span>
                        <span class="n">serverctrls</span><span class="o">=</span><span class="p">[</span><span class="n">lc</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Warning:  Server ignores RFC 2696 control.&quot;</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">results</span>

<span class="c">#</span>
<span class="c"># Replace/Set the value of a given attribute for the specified user.</span>
<span class="c">#</span>
</div>
<div class="viewcode-block" id="mldap.replace"><a class="viewcode-back" href="../mldap.html#mldap.mldap.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot; Replace/Set the value of a given attribute for the </span>
<span class="sd">       specified user. &quot;&quot;&quot;</span>
       <span class="n">mod_attrs</span> <span class="o">=</span> <span class="p">[(</span> <span class="n">ldap</span><span class="o">.</span><span class="n">MOD_REPLACE</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span> <span class="p">)]</span>
       <span class="n">dn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span>
       <span class="k">if</span> <span class="n">dn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
           <span class="k">raise</span> <span class="n">NoSuchObject</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">modify_s</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">mod_attrs</span><span class="p">)</span>

       </div>
<div class="viewcode-block" id="mldap.delete_user"><a class="viewcode-back" href="../mldap.html#mldap.mldap.delete_user">[docs]</a>    <span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Attempt to delete a given dn by referencing samaccountname. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)):</span>
            <span class="n">dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dn</span><span class="p">)</span>
            
<span class="c"># </span>
<span class="c"># Create a new account with specified attributes set.</span>
<span class="c"># All &#39;attributes&#39; are expected to be LDAP attributes</span>
<span class="c"># except for &#39;password&#39; which is properly converted</span>
<span class="c"># for unicodePwd.</span>
<span class="c">#</span>
</div>
<div class="viewcode-block" id="mldap.create"><a class="viewcode-back" href="../mldap.html#mldap.mldap.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">,</span> <span class="n">cn</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">CONSTattributes</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot; Create a new account with the specified attributes set.</span>
<span class="sd">        All &#39;attributes&#39; are expected to be LDAP attributes except</span>
<span class="sd">        for attributes[&#39;password&#39;] which is properly converted for</span>
<span class="sd">        AD&#39;s unicodePwd field. </span>

<span class="sd">        @type samaccountname: String</span>
<span class="sd">        @param samaccountname: Username to create</span>
<span class="sd">        </span>
<span class="sd">        @type cn: String</span>
<span class="sd">        @param cn: CN of new account (only the CN=(whatever))</span>
<span class="sd">        </span>
<span class="sd">        @type path: String</span>
<span class="sd">        @param path: ldap path of OU for new account</span>

<span class="sd">        @type CONSTattributes: Dictionary</span>
<span class="sd">        @param CONSTattributes: A dict of LDAP attributes for the new account.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Dictionaries are passed by reference, I do not want to </span>
        <span class="c"># modify it outside of function scope. </span>
        <span class="c"># SRGM - Jun 1, 2010</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">CONSTattributes</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">):</span>
            <span class="n">dn</span><span class="o">=</span><span class="s">&quot;CN=</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cn</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
           
            <span class="c"># The default password is &#39;changeme&#39;</span>
            <span class="k">if</span> <span class="s">&#39;password&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;changeme&#39;</span>

            <span class="c"># Encode password as unicode for AD.</span>
            <span class="n">unicode1</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;iso-8859-1&quot;</span><span class="p">)</span>
            <span class="n">unicode2</span> <span class="o">=</span> <span class="n">unicode1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-16-le&quot;</span><span class="p">)</span>
            <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unicode2</span>

            <span class="c"># TODO: Make this more general</span>
            <span class="n">userprincipalname</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">samaccountname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LDAP_DOMAIN</span><span class="p">)</span>

            <span class="n">add_record</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s">&#39;objectclass&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s">&#39;userPrincipalName&#39;</span><span class="p">,</span> <span class="n">userprincipalname</span><span class="p">),</span>
                    <span class="p">(</span><span class="s">&#39;samaccountname&#39;</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">),</span>
                    <span class="p">(</span><span class="s">&#39;cn&#39;</span><span class="p">,</span> <span class="n">cn</span><span class="p">),</span>
                    <span class="p">(</span><span class="s">&#39;unicodePwd&#39;</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]),</span>
                    <span class="c"># This will cause the account to be enabled/&quot;normal&quot;</span>
                    <span class="p">(</span><span class="s">&#39;userAccountControl&#39;</span><span class="p">,</span> <span class="s">&#39;512&#39;</span><span class="p">),</span>
                    <span class="c">#(&#39;ou&#39;, path)</span>
                    <span class="p">]</span>

            <span class="c"># Any additional attributes?</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s">&#39;password&#39;</span><span class="p">:</span>
                    <span class="n">entry</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">add_record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">add_s</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">add_record</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">CONSTRAINT_VIOLATION</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;sAMAccountName &#39;</span><span class="si">%s</span><span class="s">&#39; already exists!&quot;</span> <span class="o">%</span> <span class="n">samaccountname</span>
</div>
<div class="viewcode-block" id="mldap.create_group"><a class="viewcode-back" href="../mldap.html#mldap.mldap.create_group">[docs]</a>    <span class="k">def</span> <span class="nf">create_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; Create a new group with the specified members.</span>

<span class="sd">        @type groupname: String</span>
<span class="sd">        @param groupname: Group name to create</span>
<span class="sd">        </span>
<span class="sd">        @type path: String</span>
<span class="sd">        @param path: base CN of new group</span>
<span class="sd">        </span>
<span class="sd">        @type members: List</span>
<span class="sd">        @param members: A list of members to pre-populate group.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">groupname</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span> <span class="c"># Group already exists.</span>

        <span class="c"># Try to massage the members list into a list of DN&#39;s</span>
        <span class="n">group_members</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">members</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">members</span><span class="p">)):</span> <span class="c"># no duplicates</span>
                <span class="k">if</span> <span class="n">ad</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                    <span class="n">group_members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ad</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

        <span class="n">dn</span><span class="o">=</span><span class="s">&quot;CN=</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">groupname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
           
        <span class="n">add_record</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;objectclass&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;top&#39;</span><span class="p">,</span> <span class="s">&#39;group&#39;</span><span class="p">]),</span>
            <span class="p">(</span><span class="s">&#39;samaccountname&#39;</span><span class="p">,</span> <span class="n">groupname</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;cn&#39;</span><span class="p">,</span> <span class="n">groupname</span><span class="p">)</span>
            <span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">add_s</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">add_record</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">group_members</span><span class="p">:</span>
                <span class="n">add_to_group</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">groupname</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">CONSTRAINT_VIOLATION</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">info</span>

</div>
    <span class="k">def</span> <span class="nf">try_member_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sAMAccountName</span><span class="p">):</span>
        <span class="n">searchpath</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;cn=group,dc=base&#39;</span><span class="p">)</span>

        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;(member=</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">sAMAccountName</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">searchpath</span><span class="p">,</span>
            <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
            <span class="n">search</span><span class="p">,[</span><span class="s">&#39;distinguishedName&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c"># We need a more reliable way to get this info.</span>

<span class="c">#</span>
<span class="c"># Return a DN for a given SN (sAMAccountName)</span>
<span class="c">#</span>

<div class="viewcode-block" id="mldap.get_dn_from_sn"><a class="viewcode-back" href="../mldap.html#mldap.mldap.get_dn_from_sn">[docs]</a>    <span class="k">def</span> <span class="nf">get_dn_from_sn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">samaccountname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a DN for a given sAMAccountName &quot;&quot;&quot;</span>
        <span class="n">searchpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_BASE</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;samaccountname=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">searchpath</span><span class="p">,</span>
            <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
            <span class="n">search</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;distinguishedName&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c"># We need a more reliable way to get this info.</span>
</div>
<div class="viewcode-block" id="mldap.get_sn_from_dn"><a class="viewcode-back" href="../mldap.html#mldap.mldap.get_sn_from_dn">[docs]</a>    <span class="k">def</span> <span class="nf">get_sn_from_dn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DN</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the sAMAccountName from DN &quot;&quot;&quot;</span>
        <span class="n">search</span> <span class="o">=</span> <span class="n">DN</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">search</span><span class="p">,</span>
            <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span> 
            <span class="n">attrlist</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;sAMAccountName&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;sAMAccountName&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="mldap.replace_by_idno"><a class="viewcode-back" href="../mldap.html#mldap.mldap.replace_by_idno">[docs]</a>    <span class="k">def</span> <span class="nf">replace_by_idno</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idno</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot; Replace/Set the value of a given attribute for the specified user (by IDNO). &quot;&quot;&quot;</span>
       <span class="n">mod_attrs</span> <span class="o">=</span> <span class="p">[(</span> <span class="n">ldap</span><span class="o">.</span><span class="n">MOD_REPLACE</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span> <span class="p">)]</span>
       <span class="n">dn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dn_from_idno</span><span class="p">(</span><span class="n">idno</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">modify_s</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">mod_attrs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="mldap.get_dn_from_idno"><a class="viewcode-back" href="../mldap.html#mldap.mldap.get_dn_from_idno">[docs]</a>    <span class="k">def</span> <span class="nf">get_dn_from_idno</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idno</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a DN for a given ID.NO &quot;&quot;&quot;</span>
        <span class="n">searchpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_USER_BASE</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;employeeNumber=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">idno</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">searchpath</span><span class="p">,</span>
            <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
            <span class="n">search</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;distinguishedName&#39;</span><span class="p">])</span>

        <span class="c"># Deal with NO results:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c"># Deal with Multiple results (Should not happen):</span>
        <span class="c">#elif len(result) &gt; 1:</span>
        <span class="c">#    print &quot;ERROR! Search returned multiple results for IDNO %s &quot; % idno</span>
        <span class="c">#    print result</span>
        <span class="c">#    return 0</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c"># Return the first DN from our results </span>
                            <span class="c"># (no way we got two, right??)</span>

<span class="c">#</span>
<span class="c"># Return a given sn&#39;s idno</span>
<span class="c">#</span>
</div>
<div class="viewcode-block" id="mldap.get_idno_from_sn"><a class="viewcode-back" href="../mldap.html#mldap.mldap.get_idno_from_sn">[docs]</a>    <span class="k">def</span> <span class="nf">get_idno_from_sn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sAMAccountName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a given SN&#39;s idno.</span>
<span class="sd">        @return:  None if an error occurs.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">idno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">sAMAccountName</span><span class="p">,</span> <span class="s">&#39;employeeNumber&#39;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">idno</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

<span class="c">#</span>
<span class="c">#</span>
<span class="c">#</span>
</div>
<div class="viewcode-block" id="mldap.resetpw"><a class="viewcode-back" href="../mldap.html#mldap.mldap.resetpw">[docs]</a>    <span class="k">def</span> <span class="nf">resetpw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sAMAccountName</span><span class="p">,</span> <span class="n">newpass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Wraps around L{self.replace()} to reset a given </span>
<span class="sd">        password. Note: This attempts the administrative </span>
<span class="sd">        reset with whatever user this module binds with so </span>
<span class="sd">        make sure that it has the proper AD permissions. &quot;&quot;&quot;</span>
        
        <span class="c"># Encode password as unicode for AD.</span>
        <span class="n">unicode1</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">newpass</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;iso-8859-1&quot;</span><span class="p">)</span>
        <span class="n">unicode2</span> <span class="o">=</span> <span class="n">unicode1</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-16-le&quot;</span><span class="p">)</span>
        <span class="n">unicodePwd</span> <span class="o">=</span> <span class="n">unicode2</span> <span class="c"># Our unicoded password.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sAMAccountName</span><span class="p">,</span> <span class="s">&#39;unicodePwd&#39;</span><span class="p">,</span> <span class="n">unicodePwd</span><span class="p">)</span>





<span class="c">################################################################################</span>
<span class="c"># A few group functions</span>
<span class="c">################################################################################</span>

<span class="c">#</span>
<span class="c"># Adds a user to a given group.</span>
<span class="c">#</span>
</div>
<div class="viewcode-block" id="mldap.add_to_group"><a class="viewcode-back" href="../mldap.html#mldap.mldap.add_to_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sAMAccountName</span><span class="p">,</span> <span class="n">groupCN</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a user to a given group &quot;&quot;&quot;</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">sAMAccountName</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">groupCN</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">modify_s</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="p">[(</span><span class="n">ldap</span><span class="o">.</span><span class="n">MOD_ADD</span><span class="p">,</span> <span class="s">&#39;member&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">dn</span><span class="p">])])</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">ALREADY_EXISTS</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Cannot add </span><span class="si">%s</span><span class="s"> to group </span><span class="si">%s</span><span class="s">: user is already a member.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">sAMAccountName</span><span class="p">,</span> 
                <span class="n">groupCN</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span>

<span class="c">#</span>
<span class="c">## Remove a user from a given group.</span>
<span class="c">#</span>
</div>
<div class="viewcode-block" id="mldap.remove_from_group"><a class="viewcode-back" href="../mldap.html#mldap.mldap.remove_from_group">[docs]</a>    <span class="k">def</span> <span class="nf">remove_from_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sAMAccountName</span><span class="p">,</span> <span class="n">groupCN</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove a user from a given group. &quot;&quot;&quot;</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">sAMAccountName</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">groupCN</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">modify_s</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> 
                                      <span class="p">[(</span><span class="n">ldap</span><span class="o">.</span><span class="n">MOD_DELETE</span><span class="p">,</span> <span class="s">&#39;member&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">dn</span><span class="p">])])</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

<span class="c">#</span>
<span class="c"># Returns a list of group members.</span>
<span class="c">#</span>
</div>
<div class="viewcode-block" id="mldap.group"><a class="viewcode-back" href="../mldap.html#mldap.mldap.group">[docs]</a>    <span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groupCN</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of a given groups&#39; members &quot;&quot;&quot;</span>
        <span class="n">searchpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_BASE</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;samaccountname=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">groupCN</span><span class="p">)</span>
        <span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;member&#39;</span><span class="p">,</span> <span class="s">&#39;objectClass&#39;</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">searchpath</span><span class="p">,</span><span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span><span class="n">search</span><span class="p">,</span><span class="n">attrs</span><span class="p">)</span>
        <span class="c">#members=result[0][1][&#39;member&#39;]</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">result</span>
        
        <span class="k">return</span> <span class="n">members</span>

    <span class="c">#</span>
    <span class="c"># Return all attributes for all users who are memberOf= a given group</span>
    <span class="c">#</span></div>
    <span class="k">def</span> <span class="nf">bgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="nb">filter</span><span class="o">=</span> <span class="s">&quot;(&amp;(memberOf=</span><span class="si">%s</span><span class="s">))&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_BASE</span><span class="p">,</span>
                                  <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
                                  <span class="n">filterstr</span><span class="o">=</span><span class="nb">filter</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">unpack_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_set</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">result_set</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c"># the actual results..</span>
        <span class="n">unpacked_set</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">unpacked_set</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">unpacked_set</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">unpacked_set</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">unpacked_set</span>


<span class="c"># </span>
<span class="c"># Returns a given set of attributes for an SN, probably superceded by</span>
<span class="c"># getattr()</span>
<span class="c">#</span>

<div class="viewcode-block" id="mldap.checkuser"><a class="viewcode-back" href="../mldap.html#mldap.mldap.checkuser">[docs]</a>    <span class="k">def</span> <span class="nf">checkuser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Superceded by self.getattr() &quot;&quot;&quot;</span>
        <span class="n">searchpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_BASE</span>
        <span class="c"># This should probably look like...</span>
        <span class="c"># (&amp;(givenName=%s)(sn=%s))</span>
        <span class="c"># Search for first &amp; last name exactly:</span>
        <span class="c">#search = &#39;(&amp;(givenName=%s)(sn=%s))&#39; % (first, last)</span>
        <span class="c"># Search for first + last name:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;samaccountname=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">searchpath</span><span class="p">,</span>
            <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
            <span class="n">search</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;givenName&#39;</span><span class="p">,</span> <span class="s">&#39;sn&#39;</span><span class="p">,</span> <span class="s">&#39;initials&#39;</span><span class="p">,</span> <span class="s">&#39;last&#39;</span><span class="p">,</span> <span class="s">&#39;mail&#39;</span><span class="p">,</span> <span class="s">&#39;cn&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>


<span class="c">#</span>
<span class="c"># Verify a value (ldap compare)</span>
<span class="c">#</span>
<span class="c"># exception: ldap.NO_SUCH_ATTRIBUTE</span>
</div>
<div class="viewcode-block" id="mldap.isset"><a class="viewcode-back" href="../mldap.html#mldap.mldap.isset">[docs]</a>    <span class="k">def</span> <span class="nf">isset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Verify sAMAccountName object has attr set to value.</span>
<span class="sd">        Except: ldap.NO_SUCH_ATTRIBUTE&quot;&quot;&quot;</span>

        <span class="n">dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">compare_s</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">NO_SUCH_ATTRIBUTE</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

<span class="c">#</span>
<span class="c"># Return a multivalued attribute from AD</span>
<span class="c">#</span>
</div>
<div class="viewcode-block" id="mldap.getmattr"><a class="viewcode-back" href="../mldap.html#mldap.mldap.getmattr">[docs]</a>    <span class="k">def</span> <span class="nf">getmattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s">&quot;*&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a multiple, multivalued, attributes from AD. </span>
<span class="sd">        </span>
<span class="sd">        When working with results from LDAP the scheme is as follows:</span>
<span class="sd">            </span>
<span class="sd">        C{results[r][n]{attr}[values]}</span>
<span class="sd">        </span>
<span class="sd">        Where:</span>
<span class="sd">            - C{r = result number}</span>
<span class="sd">            - C{n[0] = dn of result}</span>
<span class="sd">            - C{n[1] = search attributes}</span>
<span class="sd">            - C{{attr} = dictionary of attribute:[values]}</span>
<span class="sd">            - C{[values] = list of values (always in list form)}</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">searchpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_BASE</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;samaccountname=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span>
        
        <span class="c"># Determine if attr is str or list type:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;str&#39;</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;list&#39;</span><span class="p">:</span>
            <span class="n">attrs</span><span class="o">=</span><span class="n">attr</span>
          
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">searchpath</span><span class="p">,</span>
            <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
            <span class="n">search</span><span class="p">,</span>
            <span class="n">attrs</span><span class="p">)</span>

        <span class="c"># result[r][n]{attr}[A]</span>
        <span class="c"># where:</span>
        <span class="c"># r = result number</span>
        <span class="c"># n = 0 for result DN, 1 for attributes</span>
        <span class="c"># (if n=1): {attr} = dictionary of attributes</span>
        <span class="c"># A = list of attribute values</span>
        
        <span class="k">return</span> <span class="n">result</span>


<span class="c">#</span>
<span class="c"># Lookup attributes on a given samaccountname</span>
<span class="c"># if not specified, return all attributes.</span>
<span class="c"># getattr(samaccountname, [attr1, attr2, ...])</span>
<span class="c"># getattr(samaccountname)</span>
<span class="c">#</span></div>
<div class="viewcode-block" id="mldap.getattr_old"><a class="viewcode-back" href="../mldap.html#mldap.mldap.getattr_old">[docs]</a>    <span class="k">def</span> <span class="nf">getattr_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s">&quot;*&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Lookup attributes on a given sAMAccountName. If </span>
<span class="sd">        not specified, return all attributes.</span>
<span class="sd">        getattr(sAMAccountName, [attr1, attr2, ...])</span>
<span class="sd">        getattr(samaccountname) &quot;&quot;&quot;</span>

        <span class="n">searchpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_BASE</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;samaccountname=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span>
        
        <span class="c"># Determine if attr is str or list type:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;str&#39;</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;list&#39;</span><span class="p">:</span>
            <span class="n">attrs</span><span class="o">=</span><span class="n">attr</span>
          
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">searchpath</span><span class="p">,</span>
            <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
            <span class="n">search</span><span class="p">,</span>
            <span class="n">attrs</span><span class="p">)</span>

        <span class="n">attributes</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c"># Because they nest it so darn deep!</span>

        <span class="c"># This reorganizes the results. Normally the ldap module</span>
        <span class="c"># allows you to get many accounts&#39; worth of results back in</span>
        <span class="c"># one go so we end up with a dictionary of lists. Ugh, we&#39;re</span>
        <span class="c"># only getting one back here so this cleans up a lot. If we</span>
        <span class="c"># passed multiple attributes we get a dict back if we passed</span>
        <span class="c"># one we get a list with one item...</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="c"># BUG: If attr=[] is a list of two items and one does not</span>
                    <span class="c"># return anything or is incorrect you will get an exception</span>
                    <span class="c"># TypeError.</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="mldap.getattr"><a class="viewcode-back" href="../mldap.html#mldap.mldap.getattr">[docs]</a>    <span class="k">def</span> <span class="nf">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s">&quot;*&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Lookup attributes on a given sAMAccountName. If </span>
<span class="sd">        not specified, return all attributes.</span>
<span class="sd">        getattr(sAMAccountName, [attr1, attr2, ...])</span>
<span class="sd">        getattr(samaccountname) </span>

<span class="sd">        @param attr:  String containing one LDAP attribute, a list of </span>
<span class="sd">        LDAP attributes, or a string containing &#39;*&#39; to return all </span>
<span class="sd">        attributes.</span>

<span class="sd">        @return: attr, a dictionary with attr keys. Multiple results </span>
<span class="sd">        are returned as a list.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">searchpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_BASE</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;samaccountname=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">searchpath</span><span class="p">,</span><span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span><span class="n">search</span><span class="p">,</span><span class="n">attrs</span><span class="p">)</span>

        <span class="n">attributes</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c"># Because they nest it so darn deep!</span>

        <span class="c"># This reorganizes the results. Normally the ldap module</span>
        <span class="c"># allows you to get many accounts&#39; worth of results back in</span>
        <span class="c"># one go so we end up with a dictionary of lists. Ugh, we&#39;re</span>
        <span class="c"># only requesting one back here so this cleans up a lot. If we</span>
        <span class="c"># passed multiple attributes we get a dict back if we passed</span>
        <span class="c"># one we get a list with one item...</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">continue</span>

            <span class="c"># Unpack a single item into a string</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c"># Otherwise, return the multi-value entry as a list.</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="s">&quot;*&quot;</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            </div>
<div class="viewcode-block" id="mldap.getuac"><a class="viewcode-back" href="../mldap.html#mldap.mldap.getuac">[docs]</a>    <span class="k">def</span> <span class="nf">getuac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retrieve the userAccountControl field for a given user.</span>

<span class="sd">        &gt;&gt;&gt; ad.getuac(&#39;shaunt&#39;).flags()</span>
<span class="sd">        [&#39;ADS_UF_NORMAL_ACCOUNT&#39;]</span>

<span class="sd">        &gt;&gt;&gt; ad.getuac(&#39;shaunt&#39;)</span>
<span class="sd">        &lt;&lt;class &#39;mldap.uac&#39;&gt; object ([&#39;ADS_UF_NORMAL_ACCOUNT&#39;])&gt;</span>

<span class="sd">        @return: a uac object derived from these flags. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">userAccountControl_flags</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">,</span> <span class="s">&#39;userAccountControl&#39;</span><span class="p">))</span>

        <span class="n">user_uac</span> <span class="o">=</span> <span class="n">uac</span><span class="p">(</span><span class="n">userAccountControl_flags</span><span class="p">)</span>
        <span class="n">user_uac</span><span class="o">.</span><span class="n">ad</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">user_uac</span><span class="o">.</span><span class="n">samaccountname</span> <span class="o">=</span> <span class="n">samaccountname</span>

        <span class="k">return</span> <span class="n">user_uac</span>

</div>
<div class="viewcode-block" id="mldap.setuac"><a class="viewcode-back" href="../mldap.html#mldap.mldap.setuac">[docs]</a>    <span class="k">def</span> <span class="nf">setuac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">,</span> <span class="n">new_uac</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the uac field for a given user.  </span>
<span class="sd">        @param new_uac: The decimal representation of the</span>
<span class="sd">        userAccountControl field (actually, any input is ok as long as</span>
<span class="sd">        it converts properly with str() which at this time means</span>
<span class="sd">        string, uac object, or int. This means &#39;512&#39;, 512, uac(512)</span>
<span class="sd">        are all acceptable. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">,</span> <span class="s">&#39;userAccountControl&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_uac</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="mldap.isdisabled"><a class="viewcode-back" href="../mldap.html#mldap.mldap.isdisabled">[docs]</a>    <span class="k">def</span> <span class="nf">isdisabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Is a given SN disabled? &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getuac</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span><span class="o">.</span><span class="n">is_set</span><span class="p">(</span>
            <span class="n">uac</span><span class="o">.</span><span class="n">ADS_UF_ACCOUNTDISABLE</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="mldap.isexpired"><a class="viewcode-back" href="../mldap.html#mldap.mldap.isexpired">[docs]</a>    <span class="k">def</span> <span class="nf">isexpired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Is a given SN expired? </span>
<span class="sd">        accountExpires is the number of ticks (100n/s [.0000001s])</span>
<span class="sd">        since 12:00AM Jan 1, 1601. Thanks, Microsoft. </span>
<span class="sd">        Additionally, it&#39;s in UTC</span>

<span class="sd">        If a user object in Active Directory has never had an</span>
<span class="sd">        expiration date, the accountExpires attribute is set to a huge</span>
<span class="sd">        number. The actual value is 2^63 - 1, or</span>
<span class="sd">        9,223,372,036,854,775,807. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">winnt_epoch</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1601</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">winnt_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">,</span> <span class="s">&#39;accountExpires&#39;</span><span class="p">))</span>
        <span class="n">winnt_time</span> <span class="o">/=</span> <span class="mi">10000000</span> <span class="c"># Convert to seconds</span>

        <span class="n">never_expires</span> <span class="o">=</span> <span class="il">922337203685L</span>

        <span class="k">if</span> <span class="n">winnt_time</span> <span class="o">==</span> <span class="n">never_expires</span> <span class="ow">or</span> <span class="n">winnt_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">;</span>

        <span class="n">expiration_date</span> <span class="o">=</span> <span class="n">winnt_epoch</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">winnt_time</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">expiration_date</span>
        
<span class="c"># </span>
<span class="c"># Search AD for a given first and last name.</span>
<span class="c">#</span>
</div>
    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>
        <span class="n">searchpath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">LDAP_USER_BASE</span>
        <span class="c"># This should probably look like...</span>
        <span class="c"># (&amp;(givenName=%s)(sn=%s))</span>
        <span class="c"># Search for first &amp; last name exactly:</span>
        <span class="c">#search = &#39;(&amp;(givenName=%s)(sn=%s))&#39; % (first, last)</span>
        <span class="c"># Search for first + last name:</span>
        <span class="n">search</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;(&amp;(objectClass=user)(!(objectClass=computer))&#39;</span>
                  <span class="s">&#39;(sn=</span><span class="si">%s</span><span class="s">)(givenName=</span><span class="si">%s</span><span class="s">))&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">last</span><span class="p">,</span><span class="n">first</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">searchpath</span><span class="p">,</span>
            <span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span>
            <span class="n">search</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;givenName&#39;</span><span class="p">,</span> <span class="s">&#39;sn&#39;</span><span class="p">,</span> <span class="s">&#39;employeeNumber&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="mldap.move"><a class="viewcode-back" href="../mldap.html#mldap.mldap.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcDN</span><span class="p">,</span> <span class="n">destDN</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; (srcdn, newrdn, destdn) &#39;&#39;&#39;</span> 
        <span class="sd">&#39;&#39;&#39; self.ldap_client.rename_s(</span>
<span class="sd">          &#39;CN=Joe D Doe,OU=Users,DC=domain,DC=com&#39;,</span>
<span class="sd">          &#39;CN=Joe D Doe&#39;,</span>
<span class="sd">          &#39;OU=OldUsers,DC=domain,DC=com&#39;</span>
<span class="sd">        ) &#39;&#39;&#39;</span>

        <span class="n">rdn</span> <span class="o">=</span> <span class="n">srcDN</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">print</span> <span class="n">srcDN</span>
        <span class="k">print</span> <span class="n">rdn</span>
        <span class="k">print</span> <span class="n">destDN</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">rename_s</span><span class="p">(</span> <span class="n">srcDN</span><span class="p">,</span> <span class="n">rdn</span><span class="p">,</span> <span class="n">destDN</span> <span class="p">)</span>
</div>
<div class="viewcode-block" id="mldap.move2"><a class="viewcode-back" href="../mldap.html#mldap.mldap.move2">[docs]</a>    <span class="k">def</span> <span class="nf">move2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname</span><span class="p">,</span> <span class="n">destOU</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This uses code not available in the older version of</span>
<span class="sd">        LDAP - consider it testing/alpha. </span>
<span class="sd">        param samaccountname: The accountname to search and move.</span>
<span class="sd">        param destOU: the folder to move the samaccountname into. </span>

<span class="sd">        &gt;&gt;&gt; self.ldap_client.rename_s(</span>
<span class="sd">            &#39;CN=Jane D Doe,OU=Users,DC=domain,DC=com&#39;, </span>
<span class="sd">            &#39;CN=Jane D Doe&#39;, </span>
<span class="sd">            &#39;OU=OldUsers,DC=domain,DC=com&#39;</span>
<span class="sd">            )</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="n">srcDN</span> <span class="o">=</span> <span class="n">ldap</span><span class="o">.</span><span class="n">dn</span><span class="o">.</span><span class="n">explode_dn</span><span class="p">(</span><span class="n">ad</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">))</span>
        
        <span class="n">rdn</span> <span class="o">=</span> <span class="n">srcDN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">rename_s</span><span class="p">(</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">srcDN</span><span class="p">),</span>
                                   <span class="n">rdn</span><span class="p">,</span>
                                   <span class="n">destOU</span> <span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">renameUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_username</span><span class="p">,</span> <span class="n">new_username</span><span class="p">):</span>
        <span class="n">ad</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old_username</span><span class="p">,</span> <span class="s">&#39;sAMAccountName&#39;</span><span class="p">,</span> <span class="n">new_username</span><span class="p">)</span>
        <span class="n">UPN_suffix</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">new_username</span><span class="p">,</span> <span class="s">&#39;userPrincipalName&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ad</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">new_username</span><span class="p">,</span> <span class="s">&#39;userPrincipalname&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span>  <span class="p">(</span><span class="n">new_username</span><span class="p">,</span> <span class="n">UPN_suffix</span><span class="p">))</span>
                                   
<span class="c">################</span>
<span class="c"># PROTOTYPE USER OBJ FUNCTIONS</span>
<span class="c">############</span>

<div class="viewcode-block" id="mldap.getattr_by_filter"><a class="viewcode-back" href="../mldap.html#mldap.mldap.getattr_by_filter">[docs]</a>    <span class="k">def</span> <span class="nf">getattr_by_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return a list of object of type ADUser given an attribute</span>
<span class="sd">        to search on. &#39;&#39;&#39;</span>
        <span class="n">search</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;objectGUID&#39;</span><span class="p">:</span>
            <span class="n">search</span> <span class="o">=</span> <span class="s">&quot;(&amp;(!(objectClass=computer))(</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">ldap</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">escape_filter_chars</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">search</span> <span class="o">=</span> <span class="s">&quot;(&amp;(!(objectClass=computer))(</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="n">searchpath</span><span class="o">=</span><span class="s">&#39;dc=mustang,dc=morningside,dc=edu&#39;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span><span class="n">searchpath</span><span class="p">,</span><span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span><span class="n">search</span><span class="p">,[])</span>

        <span class="n">attributes</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c"># Because they nest it so darn deep!</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
                
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            
            

        <span class="k">return</span> <span class="n">ret</span>

</div>
<div class="viewcode-block" id="mldap.getuser_by_filter"><a class="viewcode-back" href="../mldap.html#mldap.mldap.getuser_by_filter">[docs]</a>    <span class="k">def</span> <span class="nf">getuser_by_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matchfilter</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s">&quot;*&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Lookup attributes on a given user(s) by filter. If </span>
<span class="sd">        not specified, return all attributes.</span>
<span class="sd">        getattr(objectGUID, [attr1, attr2, ...])</span>
<span class="sd">        getattr(objectGUID) </span>

<span class="sd">        @return: attr, a dictionary with attr keys. Multiple results </span>
<span class="sd">        are returned as a list.&quot;&quot;&quot;</span>


        <span class="c"># &quot;ad.exists()&quot;</span>
        <span class="sd">&quot;&quot;&quot; Check if an account exists based on the presence of a sAMAccountName </span>
<span class="sd">        @return: True/False &quot;&quot;&quot;</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ldap</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">escape_filter_chars</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">matchfilter</span><span class="p">))</span>
        <span class="n">searchpath</span><span class="o">=</span><span class="s">&#39;dc=mustang,dc=morningside,dc=edu&#39;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span><span class="n">searchpath</span><span class="p">,</span><span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span><span class="n">search</span><span class="p">,[</span><span class="s">&#39;objectGUID&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s">&quot;objectGUID&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># Determine if attr is str or list type:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;str&#39;</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;list&#39;</span><span class="p">:</span>
            <span class="n">attrs</span><span class="o">=</span><span class="n">attr</span>
          
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span><span class="n">searchpath</span><span class="p">,</span><span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span><span class="n">search</span><span class="p">,</span><span class="n">attrs</span><span class="p">)</span>

        <span class="n">attributes</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c"># Because they nest it so darn deep!</span>

        <span class="c"># This reorganizes the results. Normally the ldap module allows you to get</span>
        <span class="c"># many accounts&#39; worth of results back in one go so we end up with a </span>
        <span class="c"># dictionary of lists. Ugh, we&#39;re only getting one back here so this </span>
        <span class="c"># cleans up a lot. If we passed multiple attributes we get a dict back</span>
        <span class="c"># if we passed one we get a list with one item...</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="s">&quot;*&quot;</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="nb">list</span><span class="p">())):</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
         
</div>
<div class="viewcode-block" id="mldap.getuser"><a class="viewcode-back" href="../mldap.html#mldap.mldap.getuser">[docs]</a>    <span class="k">def</span> <span class="nf">getuser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samaccountname_or_dn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an object of type ADUser for a given sAMAccountName or DN &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">samaccountname_or_dn</span><span class="p">:</span>
            <span class="n">samaccountname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sn_from_dn</span><span class="p">(</span><span class="n">samaccountname_or_dn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">samaccountname</span> <span class="o">=</span> <span class="n">samaccountname_or_dn</span>
            
        <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attributes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ADuser</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">,</span> <span class="n">ad_obj</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> 
                          <span class="n">attributes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">samaccountname</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        </div>
    <span class="k">def</span> <span class="nf">getgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">ADgroup</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dn_from_sn</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bgroup</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">attr_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack_attributes</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">ADuser</span><span class="p">(</span><span class="n">attr_set</span><span class="p">[</span><span class="s">&#39;sAMAccountName&#39;</span><span class="p">],</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attr_set</span><span class="p">,</span> <span class="n">ad_obj</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span>

    <span class="k">def</span> <span class="nf">getusers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">objectType</span><span class="o">=</span><span class="s">&#39;samaccountname&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LDAP_USER_BASE</span>
        <span class="n">search</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">=*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">objectType</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">search_s</span><span class="p">(</span>
            <span class="n">base</span><span class="p">,</span><span class="n">ldap</span><span class="o">.</span><span class="n">SCOPE_SUBTREE</span><span class="p">,</span><span class="n">search</span><span class="p">,[</span><span class="s">&#39;*&#39;</span><span class="p">])</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ADuser</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;sAMAccountName&#39;</span><span class="p">],</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">ad_obj</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ret</span>
            
<span class="c"># all is well, close connection</span>
<div class="viewcode-block" id="mldap.disconnect"><a class="viewcode-back" href="../mldap.html#mldap.mldap.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Close the AD/LDAP Connection if it is open. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ldap_client</span><span class="o">.</span><span class="n">unbind</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">ldap</span><span class="o">.</span><span class="n">LDAPError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># Prevent crashes on multiple disconnect() calls.</span>
            
</div></div>
<div class="viewcode-block" id="NoSuchObject"><a class="viewcode-back" href="../mldap.html#mldap.NoSuchObject">[docs]</a><span class="k">class</span> <span class="nc">NoSuchObject</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Provide a custom exception to call when we have no user to</span>
<span class="sd">    perform an action upon. &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">mldap beta documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Shaun Meyer.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>